<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Custo Por Lead</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f6; --card-color: #ffffff; --font-color: #1a1a2e;
            --font-color-light: #6c757d; --accent-blue: #007bff; --accent-green: #28a745;
            --shadow-color: rgba(0, 0, 0, 0.1); --border-color: #dee2e6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--font-color); padding: 20px; }
        .container { width: 100%; max-width: 1200px; background-color: var(--card-color); border-radius: 15px; box-shadow: 0 4px 12px var(--shadow-color); padding: 30px; border: 1px solid var(--border-color); margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        header h1 { font-weight: 700; font-size: 2.5rem; }
        .filters { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 30px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 8px; font-size: 0.9rem; font-weight: 400; color: var(--font-color-light); }
        .filter-group input { background-color: #fff; border: 1px solid var(--border-color); color: var(--font-color); padding: 12px 15px; border-radius: 8px; font-size: 1rem; }
        .update-button { cursor: pointer; background: linear-gradient(45deg, var(--accent-blue), var(--accent-green)); color: #fff; border: none; font-weight: 700; padding: 12px 15px; border-radius: 8px; font-size: 1rem; align-self: flex-end; }
        .summary-cards { display: flex; justify-content: center; gap: 30px; margin-bottom: 40px; flex-wrap: wrap; }
        .cpl-card { background-color: var(--card-color); padding: 20px 30px; border-radius: 10px; text-align: center; border-left: 5px solid; min-width: 250px; border-bottom: 1px solid var(--border-color); }
        .cpl-card h3 { font-size: 1rem; font-weight: 400; color: var(--font-color-light); margin-bottom: 10px; }
        .cpl-card .cpl-value { font-size: 2.2rem; font-weight: 700; }
        .cpl-card.bella-serra { border-color: var(--accent-blue); }
        .cpl-card.vista-bella { border-color: var(--accent-green); }
        .chart-container { position: relative; height: 50vh; width: 100%; margin-bottom: 40px; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--accent-blue); width: 60px; height: 60px; animation: spin 1s linear infinite; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .section-title { text-align: center; font-size: 1.8rem; font-weight: 700; margin-top: 40px; margin-bottom: 30px; padding-top: 30px; border-top: 1px solid var(--border-color); }
        .yearly-stats { display: flex; flex-direction: column; gap: 40px; }
        .chart-card { background: #fff; padding: 20px; border-radius: 10px; border: 1px solid var(--border-color); box-shadow: 0 2px 6px var(--shadow-color); }
        .chart-card h4 { text-align: center; margin-bottom: 15px; font-size: 1.2rem; }
        .yearly-chart-container { height: 45vh; }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Relatório de Custo Por Lead (CPL)</h1></header>
        <main>
            <section class="filters">
                <div class="filter-group"><label for="start-date">Data Inicial</label><input type="date" id="start-date"></div>
                <div class="filter-group"><label for="end-date">Data Final</label><input type="date" id="end-date"></div>
                <button id="update-btn" class="update-button">Atualizar Gráfico</button>
            </section>
            <section class="summary-cards">
                <div class="cpl-card bella-serra"><h3>CPL Médio - Bella Serra</h3><p class="cpl-value" id="avg-cpl-1">R$ 0.00</p></div>
                <div class="cpl-card vista-bella"><h3>CPL Médio - Vista Bella</h3><p class="cpl-value" id="avg-cpl-2">R$ 0.00</p></div>
            </section>
            <section class="chart-container"><div class="loader" id="loader"></div><canvas id="cplChart"></canvas></section>

            <h2 class="section-title">Análise Anual Estática</h2>
            <section class="yearly-stats">
                <div class="chart-card">
                    <h4>CPL Médio por Trimestre</h4>
                    <div class="yearly-chart-container"><canvas id="quarterlyChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h4>CPL Médio por Mês</h4>
                    <div class="yearly-chart-container"><canvas id="monthlyChart"></canvas></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- REFERÊNCIAS ---
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const updateButton = document.getElementById('update-btn');
        const loader = document.getElementById('loader');
        const mainChartCtx = document.getElementById('cplChart').getContext('2d');
        const avgCpl1Element = document.getElementById('avg-cpl-1');
        const avgCpl2Element = document.getElementById('avg-cpl-2');
        let mainChart;

        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function renderMainChart(labels, result, dataset1, dataset2) {
            if (mainChart) { mainChart.destroy(); }
            const gridColor = 'rgba(0, 0, 0, 0.1)';
            const ticksColor = '#6c757d';
            const legendColor = '#1a1a2e';
            mainChart = new Chart(mainChartCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: result.account1.name, data: dataset1.map(d => d.cpl), customData: dataset1, borderColor: 'rgba(0, 123, 255, 1)', backgroundColor: 'rgba(0, 123, 255, 0.1)', borderWidth: 3, tension: 0.4, fill: true },
                        { label: result.account2.name, data: dataset2.map(d => d.cpl), customData: dataset2, borderColor: 'rgba(40, 167, 69, 1)', backgroundColor: 'rgba(40, 167, 69, 0.1)', borderWidth: 3, tension: 0.4, fill: true }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: ticksColor, callback: value => 'R$ ' + value.toFixed(2) }, grid: { color: gridColor } },
                        x: { ticks: { color: ticksColor }, grid: { color: gridColor } }
                    },
                    plugins: {
                        legend: { labels: { color: legendColor } },
                        tooltip: {
                            callbacks: {
                                title: tooltipItems => new Date(tooltipItems[0].label).toLocaleDateString('pt-BR', { timeZone: 'UTC' }),
                                label: context => {
                                    const customData = context.dataset.customData[context.dataIndex];
                                    return [`${context.dataset.label || ''}`, `CPL: R$ ${context.parsed.y.toFixed(2)}`, `Investido: R$ ${customData.total_spend.toFixed(2)}`, `Leads: ${customData.total_results}`];
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderYearlyChart(canvasId, labels, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: data.account1.name,
                            data: data.account1.averages,
                            backgroundColor: 'rgba(0, 123, 255, 0.6)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1
                        },
                        {
                            label: data.account2.name,
                            data: data.account2.averages,
                            backgroundColor: 'rgba(40, 167, 69, 0.6)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: value => 'R$ ' + value } } },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        // --- FUNÇÕES DE BUSCA DE DADOS ---
        async function fetchAndUpdateMainChart() {
            loader.style.display = 'block';
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const apiUrl = `/get_data?start_date=${startDate}&end_date=${endDate}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Erro ao buscar os dados.');
                const data = await response.json();
                avgCpl1Element.textContent = `R$ ${data.account1.stats.average_cpl.toFixed(2)}`;
                avgCpl2Element.textContent = `R$ ${data.account2.stats.average_cpl.toFixed(2)}`;
                const allDates = new Set();
                data.account1.stats.daily_data.forEach(d => allDates.add(d.date));
                data.account2.stats.daily_data.forEach(d => allDates.add(d.date));
                const labels = Array.from(allDates).sort();
                const createDataset = (accountData) => {
                    const dataMap = new Map(accountData.stats.daily_data.map(d => [d.date, d]));
                    return labels.map(date => {
                        const dayData = dataMap.get(date);
                        return dayData ? dayData : { date: date, cpl: 0, total_spend: 0, total_results: 0 };
                    });
                };
                const dataset1 = createDataset(data.account1);
                const dataset2 = createDataset(data.account2);
                renderMainChart(labels, data, dataset1, dataset2);
            } catch (error) {
                console.error("Falha na operação:", error);
                alert("Não foi possível carregar os dados do gráfico principal.");
            } finally {
                loader.style.display = 'none';
            }
        }

        async function fetchAndRenderYearlyCharts() {
            try {
                const response = await fetch('/get_yearly_data');
                if (!response.ok) throw new Error('Falha ao buscar dados anuais');
                const data = await response.json();

                if (!data.account1 || !data.account2) {
                   throw new Error("Dados anuais recebidos em formato inesperado.");
                }

                const quarterLabels = ['1º Trim.', '2º Trim.', '3º Trim.', '4º Trim.'];
                renderYearlyChart('quarterlyChart', quarterLabels, {
                    account1: { name: data.account1.name, averages: data.account1.quarterly_averages },
                    account2: { name: data.account2.name, averages: data.account2.quarterly_averages }
                });

                const monthLabels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                renderYearlyChart('monthlyChart', monthLabels, {
                    account1: { name: data.account1.name, averages: data.account1.monthly_averages },
                    account2: { name: data.account2.name, averages: data.account2.monthly_averages }
                });

            } catch (error) {
                console.error("Erro ao buscar dados anuais:", error);
                document.querySelector('.yearly-stats').innerHTML = '<p style="text-align:center; color: var(--font-color-light);">Ocorreu um erro ao carregar os dados anuais.</p>';
            }
        }

        // --- INICIALIZAÇÃO ---
        const today = new Date();
        const thirtyDaysAgo = new Date(new Date().setDate(today.getDate() - 29));
        endDateInput.value = today.toISOString().split('T')[0];
        startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        updateButton.addEventListener('click', fetchAndUpdateMainChart);
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndUpdateMainChart();
            fetchAndRenderYearlyCharts();
        });
    </script>
</body>
</html>